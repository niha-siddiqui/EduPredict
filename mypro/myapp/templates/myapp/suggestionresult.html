{% extends "master.html"%}
{% block lala %}

  <section class="features" style="background-color: #0c1228; padding: 100px 0;">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10 col-md-11">

          <!-- Result Card -->
          <div id="result-content" style="background: linear-gradient(135deg, rgba(22,34,57,0.95) 0%, rgba(12,18,40,0.98) 100%); padding: 60px; border-radius: 10px; box-shadow: 0px 10px 50px rgba(0,0,0,0.5); border: 1px solid rgba(245,164,37,0.1); position: relative; overflow: hidden;">

            <!-- Decorative Elements -->
            <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(245,164,37,0.1) 0%, transparent 70%); border-radius: 50%;"></div>
            <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(245,164,37,0.08) 0%, transparent 70%); border-radius: 50%;"></div>

            <!-- Header Section -->
            <div style="text-align: center; margin-bottom: 50px; position: relative; z-index: 1;">
              <div style="display: inline-block; background: linear-gradient(135deg, #f5a425 0%, #ff8800 100%); width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(245,164,37,0.4);">
                <i class="fa fa-compass" style="font-size: 40px; color: #fff;"></i>
              </div>
              <h2 style="color: #fff; font-size: 36px; font-weight: 800; letter-spacing: 1px; margin-bottom: 15px; text-transform: uppercase;">
                Career <span style="color: #f5a425;">Suggestion</span> Result
              </h2>
              <div style="width: 80px; height: 3px; background: linear-gradient(90deg, transparent, #f5a425, transparent); margin: 20px auto;"></div>
            </div>

            <div style="position: relative; z-index: 1;">

              <!-- Student Info Card -->
              <div style="background: rgba(245,164,37,0.08); padding: 30px; border-radius: 8px; margin-bottom: 30px; text-align: center; border: 2px solid rgba(245,164,37,0.2);">
                <h2 style="color: #fff; font-size: 32px; font-weight: 800; margin-bottom: 10px;">{{ student.name }}</h2>
                <h3 style="color: rgba(255,255,255,0.7); font-size: 18px; font-weight: 600; margin: 0;">Class: {{ student.student_class }}</h3>
              </div>

              <!-- Score Cards -->
              <div class="row" style="margin-bottom: 30px;">
                <div class="col-md-4" style="margin-bottom: 20px;">
                  <div style="background: rgba(245,164,37,0.1); padding: 30px; border-radius: 8px; text-align: center; border-left: 4px solid #f5a425;">
                    <h4 style="color: #f5a425; font-size: 14px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px;">Predicted Score</h4>
                    <div style="font-size: 48px; font-weight: 800; color: #f5a425;">{{ student.predicted_score }}%</div>
                  </div>
                </div>

                <div class="col-md-4" style="margin-bottom: 20px;">
                  <div style="background: rgba(75,192,192,0.1); padding: 30px; border-radius: 8px; text-align: center; border-left: 4px solid #4bc0c0;">
                    <h4 style="color: #4bc0c0; font-size: 14px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px;">Current Percentage</h4>
                    <div style="font-size: 48px; font-weight: 800; color: #4bc0c0;">{% if student.predicted_score %}{{ student.predicted_score }}%{% endif %}</div>
                  </div>
                </div>

                <div class="col-md-4" style="margin-bottom: 20px;">
                  <div style="background: rgba(255,159,64,0.1); padding: 30px; border-radius: 8px; text-align: center; border-left: 4px solid #ff9f40;">
                    <h4 style="color: #ff9f40; font-size: 14px; font-weight: 700; text-transform: uppercase; margin-bottom: 12px;">Previous Percentage</h4>
                    <div style="font-size: 48px; font-weight: 800; color: #ff9f40;">{{ student.previous_percentage }}%</div>
                  </div>
                </div>
              </div>

              <!-- Recommendation Box -->
              {% if student.strength and student.field %}
              {% with student.strength.items|dictsort:"1" as sorted_strength %}
              {% with sorted_strength|last as top_subject %}
              <div style="background: linear-gradient(135deg, rgba(245,164,37,0.15) 0%, rgba(245,164,37,0.08) 100%); padding: 35px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f5a425; text-align: center;">
                <i class="fa fa-lightbulb-o" style="font-size: 48px; color: #f5a425; margin-bottom: 20px;"></i>
                <p style="color: rgba(255,255,255,0.9); font-size: 16px; line-height: 32px; margin: 0;">
                  Based on your favourite subject <strong style="color: #f5a425;">{{ student.favourite_subject }}</strong>
                  and your top scoring subject <strong style="color: #f5a425;">{{ top_subject.0 }}</strong>,
                  we suggest the following career paths:
                </p>
              </div>
              {% endwith %}
              {% endwith %}
              {% endif %}

              <!-- Subjects Performance -->
              <div class="row" style="margin-bottom: 30px;">
                <!-- Strong Subjects -->
                <div class="col-md-6" style="margin-bottom: 20px;">
                  <div style="background: rgba(75,192,192,0.08); padding: 30px; border-radius: 8px; border-left: 4px solid #4bc0c0; height: 100%;">
                    <h3 style="color: #4bc0c0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;">
                      <i class="fa fa-arrow-up" style="margin-right: 10px;"></i>Strong Subjects
                    </h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                      {% for sub, mark in student.strength.items %}
                      <li style="color: rgba(255,255,255,0.85); font-size: 15px; line-height: 32px; padding: 8px 0; border-bottom: 1px solid rgba(250,250,250,0.05); position: relative; padding-left: 30px;">
                        <i class="fa fa-check-circle" style="position: absolute; left: 0; top: 13px; color: #4bc0c0; font-size: 16px;"></i>
                        <strong>{{ sub }}:</strong> {{ mark }} marks
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>

                <!-- Weak Subjects -->
                <div class="col-md-6" style="margin-bottom: 20px;">
                  <div style="background: rgba(255,99,132,0.08); padding: 30px; border-radius: 8px; border-left: 4px solid #ff6384; height: 100%;">
                    <h3 style="color: #ff6384; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;">
                      <i class="fa fa-arrow-down" style="margin-right: 10px;"></i>Weak Subjects
                    </h3>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                      {% for sub, mark in student.weakness.items %}
                      <li style="color: rgba(255,255,255,0.85); font-size: 15px; line-height: 32px; padding: 8px 0; border-bottom: 1px solid rgba(250,250,250,0.05); position: relative; padding-left: 30px;">
                        <i class="fa fa-exclamation-circle" style="position: absolute; left: 0; top: 13px; color: #ff6384; font-size: 16px;"></i>
                        <strong>{{ sub }}:</strong> {{ mark }} marks
                      </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>

              <!-- Recommended Field -->
              <div style="background: rgba(245,164,37,0.05); padding: 30px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f5a425; text-align: center;">
                <h3 style="color: #f5a425; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">
                  <i class="fa fa-graduation-cap" style="margin-right: 10px;"></i>Recommended Field
                </h3>
                <p style="color: rgba(255,255,255,0.9); font-size: 24px; font-weight: 700; margin: 0;">{{ student.field }}</p>
              </div>

              <!-- Career Options -->
              <div style="background: rgba(245,164,37,0.03); padding: 35px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #4bc0c0;">
                <h3 style="color: #4bc0c0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px;">
                  <i class="fa fa-briefcase" style="margin-right: 10px;"></i>Top Career Options
                </h3>
                <ol style="padding-left: 25px; margin: 0;">
                  {% for career in student.careers %}
                  <li style="color: rgba(255,255,255,0.85); font-size: 16px; line-height: 36px; margin-bottom: 10px;"><strong>{{ career }}</strong></li>
                  {% endfor %}
                </ol>
              </div>

              <!-- Motivation -->
              <div style="background: linear-gradient(135deg, rgba(245,164,37,0.1) 0%, rgba(245,164,37,0.05) 100%); padding: 35px; border-radius: 8px; margin-bottom: 30px; border-left: 4px solid #f5a425; text-align: center;">
                <div style="margin-bottom: 20px;">
                  <i class="fa fa-quote-left" style="font-size: 32px; color: rgba(245,164,37,0.4);"></i>
                </div>
                <h3 style="color: #f5a425; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px;">
                  <i class="fa fa-star" style="margin-right: 10px;"></i>Motivational Message
                </h3>
                <p style="color: rgba(255,255,255,0.9); font-size: 17px; line-height: 32px; margin: 0; font-style: italic;">{{ student.motivation }}</p>
                <div style="margin-top: 20px;">
                  <i class="fa fa-quote-right" style="font-size: 32px; color: rgba(245,164,37,0.4);"></i>
                </div>
              </div>

              <!-- Charts Section -->
              <div class="row no-break" style="margin-bottom: 30px;">
                <!-- Subject Performance Chart -->
                <div class="col-md-6" style="margin-bottom: 30px;">
                  <div style="background: rgba(245,164,37,0.03); padding: 30px; border-radius: 8px; border-left: 4px solid #f5a425;">
                    <h3 style="color: #f5a425; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px; text-align: center;">
                      <i class="fa fa-bar-chart" style="margin-right: 10px;"></i>Subject-wise Performance
                    </h3>
                    <div style="background: rgba(250,250,250,0.03); padding: 20px; border-radius: 8px;">
                      <canvas id="subjectsChart" style="max-height: 300px;"></canvas>
                    </div>
                  </div>
                </div>

                <!-- Performance Trend Chart -->
                <div class="col-md-6" style="margin-bottom: 30px;">
                  <div style="background: rgba(245,164,37,0.03); padding: 30px; border-radius: 8px; border-left: 4px solid #4bc0c0;">
                    <h3 style="color: #4bc0c0; font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 25px; text-align: center;">
                      <i class="fa fa-line-chart" style="margin-right: 10px;"></i>Performance Trend
                    </h3>
                    <div style="background: rgba(250,250,250,0.03); padding: 20px; border-radius: 8px;">
                      <canvas id="percentageChart" style="max-height: 300px;"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div style="text-align: center; display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <button onclick="downloadPDF()" id="pdfBtn" style="background: linear-gradient(135deg, #4bc0c0 0%, #36a2a2 100%);
                  color: #fff; font-size: 15px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700;
                  padding: 20px 50px; border: none; cursor: pointer; border-radius: 50px;
                  box-shadow: 0px 8px 30px rgba(75,192,192,0.4); transition: all 0.4s;">
                  <i class="fa fa-download" style="margin-right: 12px;"></i>Download PDF
                </button>

                <a href="javascript:history.back()" style="display: inline-block; background: linear-gradient(135deg, #f5a425 0%, #ff8800 100%); color: #fff; font-size: 15px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; padding: 20px 50px; text-decoration: none; transition: all 0.4s; border-radius: 50px; box-shadow: 0px 8px 30px rgba(245,164,37,0.4);">
                  <i class="fa fa-arrow-left" style="margin-right: 12px;"></i>Back to Form
                </a>
              </div>

            </div>

          </div>

        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    // Subject Performance Chart
    const subjectsChartCtx = document.getElementById('subjectsChart').getContext('2d');

    const subjectsLabels = [
      {% for sub, mark in student.strength.items %}
        '{{ sub }}',
      {% endfor %}
      {% for sub, mark in student.weakness.items %}
        '{{ sub }}',
      {% endfor %}
    ];

    const subjectsData = [
      {% for sub, mark in student.strength.items %}
        {{ mark }},
      {% endfor %}
      {% for sub, mark in student.weakness.items %}
        {{ mark }},
      {% endfor %}
    ];

    // Color code based on performance
    const subjectColors = subjectsData.map(mark => {
      if (mark >= 75) return 'rgba(75, 192, 192, 0.8)';
      else if (mark >= 50) return 'rgba(245, 164, 37, 0.8)';
      else return 'rgba(255, 99, 132, 0.8)';
    });

    const subjectBorderColors = subjectsData.map(mark => {
      if (mark >= 75) return 'rgba(75, 192, 192, 1)';
      else if (mark >= 50) return 'rgba(245, 164, 37, 1)';
      else return 'rgba(255, 99, 132, 1)';
    });

    new Chart(subjectsChartCtx, {
      type: 'bar',
      data: {
        labels: subjectsLabels,
        datasets: [{
          label: 'Marks',
          data: subjectsData,
          backgroundColor: subjectColors,
          borderColor: subjectBorderColors,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(22,34,57,0.95)',
            titleColor: '#f5a425',
            bodyColor: '#fff',
            borderColor: '#f5a425',
            borderWidth: 1,
            padding: 12
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: 'rgba(250,250,250,0.05)',
              borderColor: 'rgba(250,250,250,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              font: { size: 12 }
            }
          },
          x: {
            grid: {
              display: false,
              borderColor: 'rgba(250,250,250,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              font: { size: 11 }
            }
          }
        }
      }
    });

    // Performance Trend Chart
    const percentageChartCtx = document.getElementById('percentageChart').getContext('2d');

    new Chart(percentageChartCtx, {
      type: 'line',
      data: {
        labels: ['Previous %', 'Current %', 'Predicted %'],
        datasets: [{
          label: 'Performance Trend',
          data: [
            {{ student.previous_percentage }},
            {{ student.predicted_score }},
            {{ student.predicted_score }}
          ],
          fill: true,
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 3,
          tension: 0.4,
          pointStyle: 'circle',
          pointRadius: 8,
          pointBackgroundColor: 'rgba(75, 192, 192, 1)',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointHoverRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(22,34,57,0.95)',
            titleColor: '#f5a425',
            bodyColor: '#fff',
            borderColor: '#4bc0c0',
            borderWidth: 1,
            padding: 12,
            callbacks: {
              label: function(context) {
                return 'Score: ' + context.parsed.y + '%';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: 'rgba(250,250,250,0.05)',
              borderColor: 'rgba(250,250,250,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              font: { size: 12 },
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: {
            grid: {
              display: false,
              borderColor: 'rgba(250,250,250,0.1)'
            },
            ticks: {
              color: 'rgba(255,255,255,0.7)',
              font: { size: 12 }
            }
          }
        }
      }
    });

    // PDF Download Function
    function downloadPDF() {
      const button = document.getElementById('pdfBtn');
      const originalContent = button.innerHTML;

      button.disabled = true;
      button.innerHTML = '<i class="fa fa-spinner fa-spin" style="margin-right: 12px;"></i>Generating PDF...';

      // Hide buttons before PDF generation
      const actionButtons = button.parentElement;
      actionButtons.style.display = 'none';

      const element = document.getElementById('result-content');
      const opt = {
        margin: [8, 8, 8, 8],
        filename: 'Career_Suggestion_{{ student.name|default:"Result" }}.pdf',
        image: { type: 'jpeg', quality: 0.92 },
        html2canvas: {
          scale: 1.2,
          useCORS: true,
          backgroundColor: '#0c1228',
          logging: false,
          scrollY: 0,
          scrollX: 0
        },
        jsPDF: {
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait'
        },
        pagebreak: {
          mode: ['css', 'legacy'],
          before: '.page-break-before',
          after: '.page-break-after',
          avoid: ['canvas', '.no-break']
        }
      };

      html2pdf().set(opt).from(element).save().then(() => {
        actionButtons.style.display = 'flex';
        button.disabled = false;
        button.innerHTML = originalContent;
      }).catch(err => {
        console.error('PDF generation error:', err);
        actionButtons.style.display = 'flex';
        button.disabled = false;
        button.innerHTML = originalContent;
        alert('Error generating PDF. Please try again.');
      });
    }
  </script>

  <style>
    button:hover, a[href]:hover {
      transform: translateY(-3px);
      box-shadow: 0px 12px 40px rgba(245,164,37,0.6);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none !important;
    }

    /* PDF specific styles */
    .no-break {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    @media print {
      .no-break {
        page-break-inside: avoid;
      }
    }

    @media screen and (max-width: 767px) {
      section.features > div > div > div > div {
        padding: 40px 25px !important;
      }

      h2 {
        font-size: 28px !important;
      }

      .col-md-4,
      .col-md-6 {
        margin-bottom: 20px !important;
      }

      div[style*="font-size: 48px"] {
        font-size: 36px !important;
      }

      canvas {
        max-height: 250px !important;
      }

      div[style*="display: flex"] {
        flex-direction: column !important;
      }

      button, a[href] {
        width: 100% !important;
        padding: 16px 30px !important;
      }
    }
  </style>

{% endblock %}